<!DOCTYPE html>
<html lang="lv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARCUS ADMIN | VadÄ«ba</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        /* Uzlabots Kanban izskats */
        .kanban-col { 
            min-height: 200px; 
            transition: all 0.3s ease; 
        }
        
        .sortable-ghost { 
            opacity: 0.4; 
            transform: scale(0.95);
            background: #fecaca !important; 
            border: 2px dashed #dc2626 !important; 
        }

        /* SkritulÄ“Å¡ana datorÄ */
        .kanban-container::-webkit-scrollbar { height: 6px; }
        .kanban-container::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }

        /* Mobilie labojumi */
        @media (max-width: 768px) {
            .nav-buttons {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                width: 100%;
            }
            .nav-buttons button, .nav-buttons a {
                padding: 10px 4px !important;
                font-size: 10px !important;
                justify-content: center;
            }
            .kanban-container {
                flex-direction: column;
                gap: 1.5rem;
            }
            .kanban-col {
                min-height: 100px;
            }
        }

        /* KartÄ«Å¡u animÄcija */
        .order-card {
            touch-action: manipulation;
            user-select: none;
        }
    </style>
</head>

<body class="bg-slate-50 font-sans antialiased text-slate-900">

    <nav class="bg-white border-b sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="text-2xl font-black text-red-600 italic tracking-tighter uppercase">
                    ARCUS <span class="text-slate-900">ADMIN</span>
                </div>
                
                <div class="nav-buttons flex flex-wrap gap-2">
                    <button onclick="openBannerModal()" class="flex items-center bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all">
                        ğŸ“¢ Baneris
                    </button>
                    <button onclick="fetchOrders()" class="flex items-center bg-slate-800 hover:bg-red-600 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all">
                        ğŸ”„ Atjaunot
                    </button>
                    <a href="/" class="flex items-center bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all">
                        ğŸ  MÄjaslapa
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-6 md:py-10">
        
        <div id="recent-alerts" class="mb-10 hidden">
            <div class="flex items-center gap-3 mb-4">
                <span class="flex h-3 w-3">
                    <span class="animate-ping absolute inline-flex h-3 w-3 rounded-full bg-red-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-red-600"></span>
                </span>
                <h2 class="text-xs font-black uppercase tracking-widest text-red-600 italic">Jauni pieteikumi</h2>
            </div>
            <div id="RecentOrders" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div class="kanban-container flex flex-row gap-6 overflow-x-auto pb-10">
            
            <div class="flex-1 min-w-[300px] md:min-w-[350px]">
                <div class="flex items-center justify-between mb-4 px-2">
                    <h3 class="font-black uppercase italic text-slate-700">ğŸ“¥ SaÅ†emts</h3>
                    <span id="count-SaÅ†emts" class="bg-slate-200 text-slate-600 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                </div>
                <div id="SaÅ†emts" class="kanban-col space-y-3 bg-slate-200/50 p-3 rounded-[24px] border-2 border-dashed border-slate-300/50"></div>
            </div>

            <div class="flex-1 min-w-[300px] md:min-w-[350px]">
                <div class="flex items-center justify-between mb-4 px-2">
                    <h3 class="font-black uppercase italic text-yellow-700">ğŸ”§ Remonts</h3>
                    <span id="count-Remonts" class="bg-yellow-100 text-yellow-600 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                </div>
                <div id="Remonts" class="kanban-col space-y-3 bg-yellow-50/50 p-3 rounded-[24px] border-2 border-dashed border-yellow-200/50"></div>
            </div>

            <div class="flex-1 min-w-[300px] md:min-w-[350px]">
                <div class="flex items-center justify-between mb-4 px-2">
                    <h3 class="font-black uppercase italic text-green-700">âœ… Gatavs</h3>
                    <span id="count-Gatavs" class="bg-green-100 text-green-600 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                </div>
                <div id="Gatavs" class="kanban-col space-y-3 bg-green-50/50 p-3 rounded-[24px] border-2 border-dashed border-green-200/50"></div>
            </div>

        </div>
    </main>

    <div id="orderModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-[32px] overflow-hidden shadow-2xl transform transition-all" id="modalContent">
            <div class="p-6 md:p-8">
                <div class="flex justify-between items-start mb-4">
                    <div id="modalID" class="text-[9px] font-black text-slate-400 tracking-widest"></div>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-red-600 text-xl">âœ•</button>
                </div>
                <div id="modalStatusBadge" class="inline-block px-3 py-1 rounded-full text-[9px] font-black uppercase mb-4"></div>
                <h2 id="modalName" class="text-2xl font-black text-slate-900 uppercase italic mb-1"></h2>
                <div id="modalService" class="text-red-600 font-bold uppercase tracking-widest text-[10px] mb-6"></div>
                
                <div class="space-y-6">
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                        <label class="text-[9px] font-black text-slate-400 uppercase block mb-2">Klienta ziÅ†ojums</label>
                        <p id="modalDescription" class="text-slate-700 text-sm leading-relaxed italic"></p>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 border-t pt-6">
                        <a id="modalPhone" href="" class="w-full sm:w-auto text-center bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-2xl font-black text-sm transition-all flex items-center justify-center gap-2">
                            ğŸ“ ZvanÄ«t
                        </a>
                        <div id="modalDate" class="text-[10px] font-bold text-slate-400 uppercase"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="deleteModal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-4">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeDeleteModal()"></div>
        <div class="relative bg-white rounded-[32px] shadow-2xl max-w-sm w-full p-8 text-center border-t-8 border-red-600">
            <div class="text-5xl mb-4">ğŸ—‘ï¸</div>
            <h2 class="text-xl font-black uppercase italic mb-2">DzÄ“st ierakstu?</h2>
            <p class="text-slate-500 text-xs mb-8">InformÄcija tiks neatgriezeniski dzÄ“sta no sistÄ“mas.</p>
            <div class="flex gap-3">
                <button onclick="closeDeleteModal()" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold uppercase text-[10px] tracking-widest">Atcelt</button>
                <button id="confirmDeleteBtn" onclick="executeDelete()" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold uppercase text-[10px] tracking-widest hover:bg-red-700">DzÄ“st</button>
            </div>
        </div>
    </div>

    <div id="bannerModal" class="fixed inset-0 bg-slate-950/90 backdrop-blur-md z-[150] hidden items-center justify-center p-4">
        <div class="bg-slate-900 w-full max-w-md rounded-[32px] border border-slate-800 shadow-2xl p-8 transform transition-all">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-[10px] font-black text-white uppercase tracking-widest">ğŸ“¢ Banera iestatÄ«jumi</h2>
                <button onclick="closeBannerModal()" class="text-slate-500 hover:text-white">âœ•</button>
            </div>
            <textarea id="bannerText" rows="3" class="w-full bg-slate-950 border border-slate-800 p-4 rounded-2xl text-slate-200 outline-none focus:border-red-600 transition-all text-sm mb-6 resize-none" placeholder="Ieraksti akcijas tekstu..."></textarea>
            <div class="flex items-center justify-between bg-slate-950 p-4 rounded-2xl border border-slate-800 mb-6">
                <span class="text-[10px] font-black uppercase text-slate-400">RÄdÄ«t klientiem</span>
                <button onclick="toggleBannerState()" id="bannerToggleBtn" class="relative inline-flex h-6 w-12 items-center rounded-full bg-slate-700 transition-colors">
                    <span id="bannerToggleCircle" class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1"></span>
                </button>
            </div>
            <div class="flex gap-3">
                <button onclick="closeBannerModal()" class="flex-1 bg-slate-800 text-slate-400 py-3 rounded-xl font-black uppercase text-[10px]">Atcelt</button>
                <button id="saveBtn" onclick="saveBannerSettings()" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-black uppercase text-[10px] shadow-lg shadow-red-600/20">SaglabÄt</button>
            </div>
        </div>
    </div>

    <audio id="notificationSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <script>
        const columns = ['SaÅ†emts', 'Remonts', 'Gatavs'];
        let allOrders = [];
        let currentBannerStatus = false;
        let lastOrderCount = 0;
        let orderIdToDelete = null;

        window.onload = () => {
            fetchOrders();
            loadBannerData();
            setInterval(fetchOrders, 20000); 
        };

        // Kanban InicializÄcija
        columns.forEach(status => {
            const el = document.getElementById(status);
            new Sortable(el, {
                group: 'kanban',
                animation: 200,
                draggable: '.order-card',
                ghostClass: 'sortable-ghost',
                delay: 50, // Uzlabo mobilo lietoÅ¡anu
                delayOnTouchOnly: true,
                onEnd: async (evt) => {
                    const orderId = evt.item.getAttribute('data-id');
                    const newStatus = evt.to.id;
                    updateCounts();
                    await updateOrderStatus(orderId, newStatus);
                }
            });
        });

        async function fetchOrders() {
            try {
                const response = await fetch('/api/admin/orders?t=' + Date.now());
                const data = await response.json();
                
                if (lastOrderCount !== 0 && data.length > lastOrderCount) {
                    const sound = document.getElementById('notificationSound');
                    if (sound) sound.play().catch(() => {});
                }
                lastOrderCount = data.length;
                allOrders = data;
                renderOrders(allOrders);
                updateCounts();
            } catch (e) { console.error("Datu kÄ¼Å«da:", e); }
        }

        function updateCounts() {
            columns.forEach(col => {
                const count = allOrders.filter(o => o.statuss === col).length;
                const countEl = document.getElementById(`count-${col}`);
                if(countEl) countEl.innerText = count;
            });
        }

        function renderOrders(orders) {
            columns.forEach(col => document.getElementById(col).innerHTML = '');
            const recentContainer = document.getElementById('RecentOrders');
            if(recentContainer) recentContainer.innerHTML = '';
            
            const dismissed = JSON.parse(localStorage.getItem('dismissedOrders') || '[]');
            const recentOrders = [...orders].reverse().filter(o => !dismissed.includes(o.id) && o.statuss === 'SaÅ†emts').slice(0, 3);
            
            const alertsDiv = document.getElementById('recent-alerts');
            if (recentOrders.length > 0) {
                alertsDiv.classList.remove('hidden');
                recentOrders.forEach(o => recentContainer.insertAdjacentHTML('beforeend', createCardHtml(o, true)));
            } else {
                alertsDiv.classList.add('hidden');
            }

            orders.forEach(o => {
                const targetCol = document.getElementById(o.statuss);
                if (targetCol) targetCol.insertAdjacentHTML('beforeend', createCardHtml(o, false));
            });
        }

        function createCardHtml(order, isHighlighted) {
            const shadow = isHighlighted ? 'shadow-red-200' : 'shadow-sm';
            return `
                <div onclick="openModal('${order.id}')" data-id="${order.id}" 
                     class="order-card bg-white p-4 rounded-2xl border border-slate-200 ${shadow} cursor-pointer hover:border-red-500 transition-all group relative">
                    <button onclick="event.stopPropagation(); openDeleteModal('${order.id}')" 
                            class="absolute top-3 right-3 text-slate-300 hover:text-red-600 p-1 z-20">âœ•</button>
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-2 h-2 rounded-full ${isHighlighted ? 'bg-red-600 animate-pulse' : 'bg-slate-300'}"></div>
                        <h4 class="font-bold text-slate-800 uppercase text-xs truncate pr-6">${order.vards}</h4>
                    </div>
                    <p class="text-[10px] text-slate-500 font-medium">${order.pakalpojums}</p>
                    ${isHighlighted ? `<button onclick="event.stopPropagation(); dismissNew('${order.id}')" class="mt-3 text-[9px] font-black text-green-600 uppercase">âœ“ AtzÄ«mÄ“t kÄ skatÄ«tu</button>` : ''}
                </div>`;
        }

        // --- Statusa atjaunoÅ¡ana ---
        async function updateOrderStatus(id, newStatus) {
            const order = allOrders.find(o => o.id === id);
            if(order) order.statuss = newStatus;
            try {
                await fetch('/api/admin/update-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, newStatus })
                });
            } catch (e) { console.error("Servera kÄ¼Å«da:", e); }
        }

        // --- DzÄ“Å¡anas funkcijas ---
        function openDeleteModal(id) { 
            orderIdToDelete = id; 
            document.getElementById('deleteModal').classList.remove('hidden'); 
        }
        function closeDeleteModal() { 
            document.getElementById('deleteModal').classList.add('hidden'); 
        }
        async function executeDelete() {
            if (!orderIdToDelete) return;
            try {
                await fetch(`/api/admin/delete/${orderIdToDelete}`, { method: 'DELETE' });
                closeDeleteModal();
                fetchOrders();
            } catch (e) { alert("NeizdevÄs dzÄ“st"); }
        }

        // --- ModÄlie logi ---
        function openModal(id) {
            const order = allOrders.find(o => o.id === id);
            if (!order) return;
            
            document.getElementById('modalID').innerText = `#${order.id.slice(-6)}`;
            document.getElementById('modalName').innerText = order.vards;
            document.getElementById('modalService').innerText = order.pakalpojums;
            document.getElementById('modalDescription').innerText = order.apraksts || 'Nav apraksta.';
            document.getElementById('modalPhone').innerText = `ğŸ“ ZvanÄ«t: ${order.talrunis}`;
            document.getElementById('modalPhone').href = `tel:${order.talrunis}`;
            document.getElementById('modalDate').innerText = order.datums;
            
            const badge = document.getElementById('modalStatusBadge');
            badge.innerText = order.statuss;
            badge.className = `inline-block px-3 py-1 rounded-full text-[9px] font-black uppercase ${
                order.statuss === 'Gatavs' ? 'bg-green-100 text-green-600' : 
                order.statuss === 'Remonts' ? 'bg-yellow-100 text-yellow-600' : 'bg-red-100 text-red-600'
            }`;

            document.getElementById('orderModal').classList.remove('hidden');
            document.getElementById('orderModal').classList.add('flex');
        }

        function closeModal() { document.getElementById('orderModal').classList.replace('flex', 'hidden'); }
        function dismissNew(id) {
            let dismissed = JSON.parse(localStorage.getItem('dismissedOrders') || '[]');
            dismissed.push(id);
            localStorage.setItem('dismissedOrders', JSON.stringify(dismissed));
            fetchOrders();
        }

        // --- Banera funkcijas ---
        async function loadBannerData() {
            const res = await fetch('/api/settings/banner');
            const data = await res.json();
            currentBannerStatus = data.enabled;
            document.getElementById('bannerText').value = data.text || "";
            updateBannerModalUI();
        }

        function openBannerModal() { document.getElementById('bannerModal').classList.replace('hidden', 'flex'); }
        function closeBannerModal() { document.getElementById('bannerModal').classList.replace('flex', 'hidden'); }
        function toggleBannerState() { currentBannerStatus = !currentBannerStatus; updateBannerModalUI(); }

        function updateBannerModalUI() {
            const btn = document.getElementById('bannerToggleBtn');
            const circle = document.getElementById('bannerToggleCircle');
            if (currentBannerStatus) {
                btn.classList.replace('bg-slate-700', 'bg-red-600');
                circle.classList.replace('translate-x-1', 'translate-x-7');
            } else {
                btn.classList.replace('bg-red-600', 'bg-slate-700');
                circle.classList.replace('translate-x-7', 'translate-x-1');
            }
        }

        async function saveBannerSettings() {
            const text = document.getElementById('bannerText').value;
            await fetch('/api/settings/banner', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: currentBannerStatus, text })
            });
            closeBannerModal();
        }

        window.onclick = (e) => {
            if (e.target.id === 'orderModal') closeModal();
            if (e.target.id === 'bannerModal') closeBannerModal();
        }
    </script>
</body>
</html>
