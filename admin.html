<!DOCTYPE html>
<html lang="lv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARCUS ADMIN | VadÄ«ba</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        .kanban-col { min-height: 200px; transition: all 0.3s ease; }
        .sortable-ghost { opacity: 0.4; transform: scale(0.95); background: #fecaca !important; border: 2px dashed #dc2626 !important; }
        .kanban-container::-webkit-scrollbar { height: 6px; }
        .kanban-container::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        
        @media (max-width: 768px) {
            .nav-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; }
            .nav-buttons button, .nav-buttons a { padding: 10px 4px !important; font-size: 10px !important; justify-content: center; }
            .kanban-container { flex-direction: column; gap: 1.5rem; }
            .kanban-col { min-height: 100px; }
        }
        .order-card {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
        
        /* Meistara ikonas stils */
        .master-badge {
    width: 22px; 
    height: 22px;
    display: flex; 
    align-items: center; 
    justify-content: center;
    border-radius: 50%; 
    font-size: 9px; 
    font-weight: 900;
    color: white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
}
    </style>
</head>

<body class="bg-slate-50 font-sans antialiased text-slate-900">

    <nav class="bg-white border-b sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4 italic flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-2xl font-black text-red-600 tracking-tighter uppercase">
                ARCUS <span class="text-slate-900">ADMIN</span>
            </div>
            <div class="nav-buttons flex flex-wrap gap-2">
                <button onclick="openBannerModal()" class="flex items-center bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all">ğŸ“¢ Baneris</button>
                <button onclick="fetchOrders()" class="flex items-center bg-slate-800 hover:bg-red-600 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all">ğŸ”„ Atjaunot</button>
                <a href="/" class="flex items-center bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all">ğŸ  MÄjaslapa</a>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-6 md:py-10">
        
        <div id="recent-alerts" class="mb-10 hidden">
            <div class="flex items-center gap-3 mb-4">
                <span class="relative flex h-3 w-3">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-red-600"></span>
                </span>
                <h2 class="text-xs font-black uppercase tracking-widest text-red-600 italic">Jauni pieteikumi</h2>
            </div>
            <div id="RecentOrders" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div class="flex flex-wrap gap-2 mb-6 items-center bg-white p-3 rounded-[24px] border border-slate-200 shadow-sm">
    <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest px-3">FiltrÄ“t meistaru:</span>
    <button onclick="filterByMaster('all')" id="filter-all" class="filter-btn active bg-red-600 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-all">Visi</button>
    <button onclick="filterByMaster('Juris')" id="filter-Juris" class="filter-btn bg-slate-100 text-slate-500 px-4 py-2 rounded-xl text-[10px] font-black uppercase hover:bg-slate-200 transition-all">Juris</button>
    <button onclick="filterByMaster('Andris')" id="filter-Andris" class="filter-btn bg-slate-100 text-slate-500 px-4 py-2 rounded-xl text-[10px] font-black uppercase hover:bg-slate-200 transition-all">Andris</button>
    <button onclick="filterByMaster('MÄris')" id="filter-MÄris" class="filter-btn bg-slate-100 text-slate-500 px-4 py-2 rounded-xl text-[10px] font-black uppercase hover:bg-slate-200 transition-all">MÄris</button>
</div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="md:col-span-2 bg-white p-4 rounded-[24px] border border-slate-200 flex items-center justify-around shadow-sm">
                <div class="text-center">
                    <div class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Å odien</div>
                    <div id="stats-today" class="text-xl font-black text-red-600">0</div>
                </div>
                <div class="w-px h-8 bg-slate-100"></div>
                <div class="text-center">
                    <div class="text-[9px] font-black text-slate-400 uppercase tracking-widest">AktÄ«vie</div>
                    <div id="stats-active" class="text-xl font-black text-slate-900">0</div>
                </div>
                <div class="w-px h-8 bg-slate-100"></div>
                <div class="text-center">
                    <div class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Pabeigti</div>
                    <div id="stats-done" class="text-xl font-black text-green-600">0</div>
                </div>
            </div>

            

            <div class="relative">
                <input type="text" id="searchInput" oninput="handleSearch()" 
                       placeholder="MeklÄ“t klientu vai tel..." 
                       class="w-full h-full bg-white border border-slate-200 rounded-[24px] px-6 py-4 text-sm outline-none focus:border-red-600 transition-all shadow-sm">
                <span class="absolute right-5 top-1/2 -translate-y-1/2 opacity-30 text-lg">ğŸ”</span>
            </div>
        </div>

        <div class="kanban-container flex flex-row gap-6 overflow-x-auto pb-10">
            <div class="flex-1 min-w-[300px] md:min-w-[350px]">
                <div class="flex items-center justify-between mb-4 px-2">
                    <h3 class="font-black uppercase italic text-slate-700">ğŸ“¥ SaÅ†emts</h3>
                    <span id="count-SaÅ†emts" class="bg-slate-200 text-slate-600 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                </div>
                <div id="SaÅ†emts" class="kanban-col space-y-3 bg-slate-200/50 p-3 rounded-[24px] border-2 border-dashed border-slate-300/50"></div>
            </div>

            <div class="flex-1 min-w-[300px] md:min-w-[350px]">
                <div class="flex items-center justify-between mb-4 px-2">
                    <h3 class="font-black uppercase italic text-yellow-700">ğŸ”§ Remonts</h3>
                    <span id="count-Remonts" class="bg-yellow-100 text-yellow-600 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                </div>
                <div id="Remonts" class="kanban-col space-y-3 bg-yellow-50/50 p-3 rounded-[24px] border-2 border-dashed border-yellow-200/50"></div>
            </div>

            <div class="flex-1 min-w-[300px] md:min-w-[350px]">
                <div class="flex items-center justify-between mb-4 px-2">
                    <h3 class="font-black uppercase italic text-green-700">âœ… Gatavs</h3>
                    <span id="count-Gatavs" class="bg-green-100 text-green-600 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                </div>
                <div id="Gatavs" class="kanban-col space-y-3 bg-green-50/50 p-3 rounded-[24px] border-2 border-dashed border-green-200/50"></div>
            </div>
        </div>
    </main>

    <div id="orderModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-[32px] overflow-hidden shadow-2xl transform transition-all max-h-[90vh] overflow-y-auto" id="modalContent">
            <div class="p-6 md:p-8">
                <div class="flex justify-between items-start mb-4">
                    <div id="modalID" class="text-[9px] font-black text-slate-400 tracking-widest uppercase"></div>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-red-600 text-xl">âœ•</button>
                </div>
                <div id="modalStatusBadge" class="inline-block px-3 py-1 rounded-full text-[9px] font-black uppercase mb-4"></div>
                
                <h2 id="modalName" class="text-2xl font-black text-slate-900 uppercase italic mb-1"></h2>
                
                <div class="mb-6 mt-4">
                    <label class="text-[9px] font-black text-slate-400 uppercase block mb-2 px-1">AtbildÄ«gais Meistars</label>
                    <select id="masterSelect" onchange="updateMaster()" class="w-full bg-slate-50 border border-slate-200 rounded-2xl p-3 text-sm font-bold outline-none focus:border-red-600 transition-all cursor-pointer">
                        <option value="">-- Nav pieÅ¡Ä·irts --</option>
                        <option value="Juris">Juris</option>
                        <option value="Andris">Andris</option>
                        <option value="MÄris">MÄris</option>
                    </select>
                </div>

                <div id="modalService" class="text-red-600 font-bold uppercase tracking-widest text-[10px] mb-6"></div>
                
                <div class="space-y-6">
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                        <label class="text-[9px] font-black text-slate-400 uppercase block mb-2">Klienta ziÅ†ojums</label>
                        <p id="modalDescription" class="text-slate-700 text-sm leading-relaxed italic"></p>
                    </div>

                    <div class="bg-slate-100/50 p-4 rounded-2xl border border-slate-100">
                        <label class="text-[9px] font-black text-slate-400 uppercase block mb-3">Remontu vÄ“sture</label>
                        <div id="modalHistory" class="space-y-2"></div>
                    </div>

                    <div class="mb-4">
                        <label class="text-[9px] font-black text-slate-400 uppercase block mb-1">E-pasts</label>
                        <a id="modalEmail" href="" class="text-sm font-bold text-slate-700 hover:text-red-600 underline"></a>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 border-t pt-6">
                        <a id="modalPhone" href="" class="w-full sm:w-auto text-center bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-2xl font-black text-sm transition-all flex items-center justify-center gap-2">ğŸ“ ZvanÄ«t</a>
                        <div id="modalDate" class="text-[10px] font-bold text-slate-400 uppercase"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="deleteModal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-4">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeDeleteModal()"></div>
        <div class="relative bg-white rounded-[32px] shadow-2xl max-w-sm w-full p-8 text-center border-t-8 border-red-600">
            <div class="text-5xl mb-4">ğŸ—‘ï¸</div>
            <h2 class="text-xl font-black uppercase italic mb-2">DzÄ“st ierakstu?</h2>
            <div class="flex gap-3 mt-8">
                <button onclick="closeDeleteModal()" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold uppercase text-[10px]">Atcelt</button>
                <button id="confirmDeleteBtn" onclick="deleteOrder()" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold uppercase text-[10px]">DzÄ“st</button>
            </div>
        </div>
    </div>

    <div id="bannerModal" class="fixed inset-0 bg-slate-950/90 backdrop-blur-md z-[150] hidden items-center justify-center p-4">
        <div class="bg-slate-900 w-full max-w-md rounded-[32px] border border-slate-800 p-8 shadow-2xl">
            <h2 class="text-[10px] font-black text-white uppercase tracking-widest mb-6">ğŸ“¢ Banera iestatÄ«jumi</h2>
            <textarea id="bannerText" rows="3" class="w-full bg-slate-950 border border-slate-800 p-4 rounded-2xl text-slate-200 text-sm mb-6 outline-none focus:border-red-600" placeholder="Akcijas teksts..."></textarea>
            <div class="flex items-center justify-between bg-slate-950 p-4 rounded-2xl border border-slate-800 mb-6">
                <span class="text-[10px] font-black uppercase text-slate-400">RÄdÄ«t klientiem</span>
                <button onclick="toggleBannerState()" id="bannerToggleBtn" class="relative inline-flex h-6 w-12 items-center rounded-full bg-slate-700 transition-colors">
                    <span id="bannerToggleCircle" class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1"></span>
                </button>
            </div>
            <div class="flex gap-3">
                <button onclick="closeBannerModal()" class="flex-1 bg-slate-800 text-slate-400 py-3 rounded-xl font-black uppercase text-[10px]">Atcelt</button>
                <button onclick="saveBannerSettings()" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-black uppercase text-[10px]">SaglabÄt</button>
            </div>
        </div>
    </div>

    <audio id="notificationSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <script>
        const columns = ['SaÅ†emts', 'Remonts', 'Gatavs'];
        const masterColors = { 'Juris': '#ef4444', 'Andris': '#3b82f6', 'MÄris': '#10b981', 'default': '#cbd5e1' };
        let allOrders = [];
        let currentBannerStatus = false;
        let lastOrderCount = 0;
        let orderIdToDelete = null;
        let currentOpenOrderId = null;
        let currentOrderId = null;
        let activeMasterFilter = 'all';
        
        // Å IS BIJA TRÅªKSTOÅ AIS MAINÄªGAIS
        let isDragging = false; 

        window.onload = () => { 
            fetchOrders(); 
            loadBannerData(); 
            // PalielinÄm intervÄlu lÄ«dz 30s, lai vÄ“l vairÄk samazinÄtu konfliktus
            setInterval(fetchOrders, 30000); 
        };

        // KANBAN VILKÅ ANA
        columns.forEach(status => {
            const colEl = document.getElementById(status);
            if (!colEl) return;

            new Sortable(colEl, {
                group: 'kanban', 
                animation: 200, 
                draggable: '.order-card', 
                ghostClass: 'sortable-ghost',
                // SÄkam vilkt - bloÄ·Ä“jam auto-atjaunoÅ¡anos
                onStart: () => {
                    isDragging = true;
                },
                onEnd: async (evt) => {
                    const id = evt.item.getAttribute('data-id');
                    const newStatus = evt.to.id;

                    if (evt.from === evt.to && evt.oldIndex === evt.newIndex) {
                        isDragging = false;
                        return;
                    }

                    // 1. VizuÄla bloÄ·Ä“Å¡ana
                    evt.item.style.opacity = '0.5';
                    evt.item.style.pointerEvents = 'none';

                    // 2. LokÄlÄ stÄvokÄ¼a maiÅ†a (tÅ«lÄ«tÄ“ja)
                    const orderIndex = allOrders.findIndex(o => o.id === id);
                    if (orderIndex !== -1) {
                        allOrders[orderIndex].statuss = newStatus;
                    }
                    updateCounts();

                    try {
                        const response = await fetch('/api/admin/update-status', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ id, newStatus })
                        });
                        
                        if (!response.ok) throw new Error();
                    } catch (e) {
                        console.error("KÄ¼Å«da:", e);
                        fetchOrders(); // Ja kÄ¼Å«da, pÄrlÄdÄ“jam visu
                    } finally {
                        // 3. AtbloÄ·Ä“jam
                        evt.item.style.opacity = '1';
                        evt.item.style.pointerEvents = 'auto';
                        // Ä»aujam fetchOrders atkal strÄdÄt pÄ“c 2 sekundÄ“m (droÅ¡Ä«bai)
                        setTimeout(() => { isDragging = false; }, 2000);
                    }
                }
            });
        });

        async function fetchOrders() {
            // Ja lietotÄjs velk vai tikko pabeidza, neaiztiekam DOM
            if (isDragging) return; 
            
            try {
                const res = await fetch('/api/admin/orders?t=' + Date.now());
                const data = await res.json();
                
                allOrders = data; 
                
                if (lastOrderCount !== 0 && data.length > lastOrderCount) {
                    document.getElementById('notificationSound')?.play().catch(()=>{});
                }
                lastOrderCount = data.length;
                
                handleSearch(); 
                updateCounts();
            } catch (e) { 
                console.error("Datu ielÄdes kÄ¼Å«da:", e); 
            }
        }

        function filterByMaster(master) {
    activeMasterFilter = master;
    
    // VizuÄli atjaunojam pogu stilus
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-red-600', 'text-white');
        btn.classList.add('bg-slate-100', 'text-slate-500');
    });
    
    const activeBtn = document.getElementById(`filter-${master}`);
    activeBtn.classList.remove('bg-slate-100', 'text-slate-500');
    activeBtn.classList.add('active', 'bg-red-600', 'text-white');

    // Izsaucam meklÄ“Å¡anu, lai atjaunotu sarakstu
    handleSearch();
}

        function renderOrders(orders, isSearching = false) {
    // 1. IztÄ«rÄm visas kolonnas un paziÅ†ojumu joslu
    columns.forEach(col => {
        const el = document.getElementById(col);
        if (el) el.innerHTML = '';
    });
    
    const recentContainer = document.getElementById('RecentOrders');
    const alertsDiv = document.getElementById('recent-alerts');
    if (recentContainer) recentContainer.innerHTML = '';

    const dismissed = JSON.parse(localStorage.getItem('dismissedOrders') || '[]');
    let alreadyRenderedIds = new Set();

    // 2. ApstrÄdÄjam "Jaunos pieteikumus" (sarkanÄ josla augÅ¡Ä)
    // RÄdÄm tos tikai tad, ja NAV meklÄ“Å¡anas reÅ¾Ä«ms
    if (!isSearching) {
        const recent = allOrders.filter(o => 
            !dismissed.includes(o.id) && 
            o.statuss === 'SaÅ†emts'
        ).reverse().slice(0, 3);

        if (recent.length > 0) {
            alertsDiv.classList.remove('hidden');
            recent.forEach(o => {
                recentContainer.insertAdjacentHTML('beforeend', createCardHtml(o, true));
                alreadyRenderedIds.add(o.id); // AtzÄ«mÄ“jam, ka Å¡is jau ir uzzÄ«mÄ“ts
            });
        } else {
            alertsDiv.classList.add('hidden');
        }
    } else {
        alertsDiv.classList.add('hidden');
    }

    // 3. ZÄ«mÄ“jam visas pÄrÄ“jÄs kartÄ«tes kolonnÄs
    orders.forEach(o => {
        // Ja pieteikums jau ir uzzÄ«mÄ“ts augÅ¡Ä“jÄ joslÄ, izlaiÅ¾am to kolonnÄ
        if (alreadyRenderedIds.has(o.id)) return;

        const col = document.getElementById(o.statuss);
        if (col) {
            col.insertAdjacentHTML('beforeend', createCardHtml(o, false));
        }
    });
}

        function dismissNew(id) {
    let dismissed = JSON.parse(localStorage.getItem('dismissedOrders') || '[]');
    if (!dismissed.includes(id)) {
        dismissed.push(id);
        localStorage.setItem('dismissedOrders', JSON.stringify(dismissed));
    }
    fetchOrders(); // Å is pÄrzÄ«mÄ“s visu un paziÅ†ojums pazudÄ«s
}

        function createCardHtml(order, isHighlighted) {
    const mInit = order.meistars ? order.meistars.charAt(0) : '?';
    const mCol = masterColors[order.meistars] || masterColors['default'];
    const shadow = isHighlighted ? 'shadow-lg shadow-red-100 border-red-200' : 'shadow-sm border-slate-200';
    
    return `
        <div onclick="openModal('${order.id}')" data-id="${order.id}" 
             class="order-card bg-white p-5 rounded-[22px] border ${shadow} cursor-pointer hover:border-red-400 hover:shadow-md transition-all group relative flex flex-col min-h-[110px]">
            
            <button onclick="event.stopPropagation(); ${isHighlighted ? `dismissNew('${order.id}')` : `openDeleteModal('${order.id}')`}"
                    class="absolute top-2 right-2 w-8 h-8 flex items-center justify-center rounded-full bg-slate-50 text-slate-400 hover:bg-red-50 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-all z-20">
                <span class="text-xs">âœ•</span>
            </button>
            
            <div class="pr-6">
                <div class="flex items-center gap-2 mb-1.5">
                    ${isHighlighted ? '<span class="flex h-2 w-2 rounded-full bg-red-600 animate-pulse"></span>' : ''}
                    <h4 class="font-black text-slate-900 uppercase text-[11px] tracking-tight truncate">
                        ${order.vards}
                    </h4>
                </div>
                
                <p class="text-[10px] text-slate-500 font-medium leading-relaxed italic line-clamp-2">
                    ${order.pakalpojums}
                </p>
            </div>
            
            <div class="mt-auto pt-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="text-[8px] font-black text-slate-300 uppercase tracking-widest">
                        #${order.id.slice(-4)}
                    </div>
                    
                    <button onclick="event.stopPropagation(); openWhatsApp('${order.vards}', '${order.talrunis}', '${order.pakalpojums}', '${order.statuss}')" 
                            class="text-green-500 hover:text-green-600 transition-transform hover:scale-110 p-1"
                            title="SÅ«tÄ«t WhatsApp ziÅ†u">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                        </svg>
                    </button>
                </div>
                
                <div class="master-badge ring-4 ring-white" style="background-color: ${mCol}">
                    ${mInit}
                </div>
            </div>

            ${isHighlighted ? `
                <div class="absolute -bottom-2 left-5">
                    <button onclick="event.stopPropagation(); dismissNew('${order.id}')" 
                            class="bg-green-500 text-white text-[8px] font-black px-3 py-1 rounded-full uppercase shadow-lg shadow-green-200 hover:bg-green-600 transition-colors">
                        âœ“ Jauns
                    </button>
                </div>
            ` : ''}
        </div>`;
}

        async function openModal(id) {
            currentOpenOrderId = id;
            const order = allOrders.find(o => o.id === id);
            if (!order) return;

            document.getElementById('modalID').innerText = `#${order.id.slice(-6)}`;
            document.getElementById('modalName').innerText = order.vards;
            document.getElementById('modalService').innerText = order.pakalpojums;
            document.getElementById('modalDescription').innerText = order.apraksts || 'Nav apraksta.';
            document.getElementById('modalEmail').innerText = order.email || order.epasts || 'Nav norÄdÄ«ts';
            document.getElementById('modalEmail').href = `mailto:${order.email || order.epasts}`;
            document.getElementById('modalPhone').innerText = `ğŸ“ ZvanÄ«t: ${order.talrunis}`;
            document.getElementById('modalPhone').href = `tel:${order.talrunis}`;
            document.getElementById('modalDate').innerText = order.datums;
            document.getElementById('masterSelect').value = order.meistars || "";
            
            const badge = document.getElementById('modalStatusBadge');
            badge.innerText = order.statuss;
            badge.className = `inline-block px-3 py-1 rounded-full text-[9px] font-black uppercase ${order.statuss === 'Gatavs' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`;

            loadCustomerHistory(order.talrunis); 
            document.getElementById('orderModal').classList.replace('hidden', 'flex');
        }

        async function loadCustomerHistory(phone) {
    const container = document.getElementById('modalHistory');
    try {
        const res = await fetch(`/api/admin/history?phone=${phone}`);
        const history = await res.json();
        
        // AtlasÄm citus ierakstus, izÅ†emot paÅ¡reizÄ“jo atvÄ“rto
        const others = history.filter(o => o.id !== currentOpenOrderId);
        
        if (others.length > 0) {
            container.innerHTML = others.map(o => `
                <details class="group border-l-2 border-red-500 bg-slate-50/50 rounded-r-lg mb-2">
                    <summary class="flex justify-between items-center cursor-pointer p-2 list-none outline-none">
                        <div>
                            <p class="text-[10px] font-black text-slate-700 uppercase">${o.pakalpojums}</p>
                            <p class="text-[9px] text-slate-400">${o.datums} â€” <span class="text-red-600 font-bold">${o.statuss}</span></p>
                        </div>
                        <span class="text-slate-400 group-open:rotate-180 transition-transform text-[10px]">â–¼</span>
                    </summary>
                    <div class="px-3 pb-3 pt-1 border-t border-slate-100">
                        <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Apraksts:</p>
                        <p class="text-[11px] text-slate-600 italic leading-relaxed">
                            ${o.apraksts || 'Nav pievienots apraksts.'}
                        </p>
                        ${o.meistars ? `<p class="text-[9px] mt-2 text-slate-500 font-bold uppercase">Meistars: ${o.meistars}</p>` : ''}
                    </div>
                </details>
            `).join('');
        } else {
            container.innerHTML = '<p class="text-[9px] text-slate-400 italic p-2">Nav iepriekÅ¡Ä“ju pieteikumu Å¡im tÄlrunim.</p>';
        }
    } catch (e) { 
        console.error(e);
        container.innerHTML = '<p class="text-red-500 text-[9px]">KÄ¼Å«da ielÄdÄ“jot vÄ“sturi</p>'; 
    }
}

        async function updateMaster() {
            const val = document.getElementById('masterSelect').value;
            const order = allOrders.find(o => o.id === currentOpenOrderId);
            if(order) order.meistars = val;
            renderOrders(allOrders);
            await fetch('/api/admin/update-master', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: currentOpenOrderId, meistars: val })
            });
        }

        async function updateOrderStatus(id, newStatus) {
    // Atjaunojam lokÄli, lai novÄ“rstu "lÄ“kÄÅ¡anu" atpakaÄ¼
    const order = allOrders.find(o => o.id === id);
    if (order) {
        order.statuss = newStatus;
        updateCounts();
    }

    try {
        const response = await fetch('/api/admin/update-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, newStatus })
        });
        
        if (!response.ok) throw new Error('Servera kÄ¼Å«da');
    } catch (e) {
        console.error("NeizdevÄs saglabÄt statusu:", e);
        // Ja neizdevÄs saglabÄt, pÄrlÄdÄ“jam datus no servera, lai atjaunotu patieso stÄvokli
        fetchOrders();
    }
}

        function handleSearch() {
    const q = document.getElementById('searchInput').value.toLowerCase();
    
    const filtered = allOrders.filter(o => {
        // PÄrbauda tekstu
        const matchesQuery = o.vards.toLowerCase().includes(q) || 
                             o.talrunis.includes(q) || 
                             (o.id && o.id.toLowerCase().includes(q));
        
        // PÄrbauda meistaru
        const matchesMaster = (activeMasterFilter === 'all') || (o.meistars === activeMasterFilter);
        
        return matchesQuery && matchesMaster;
    });
    
    const isActiveFilter = q !== "" || activeMasterFilter !== 'all';
    renderOrders(filtered, isActiveFilter);
}

        function closeModal() { document.getElementById('orderModal').classList.replace('flex', 'hidden'); currentOpenOrderId = null; }
        function updateCounts() {
            columns.forEach(col => document.getElementById(`count-${col}`).innerText = allOrders.filter(o => o.statuss === col).length);
            document.getElementById('stats-active').innerText = allOrders.filter(o => o.statuss !== 'Gatavs').length;
            document.getElementById('stats-done').innerText = allOrders.filter(o => o.statuss === 'Gatavs').length;
            document.getElementById('stats-today').innerText = allOrders.filter(o => o.datums.includes(new Date().toLocaleDateString('lv-LV'))).length;
        }
        function openDeleteModal(id) {
    currentOrderId = id; 
    const modal = document.getElementById('deleteModal');
    if (modal) {
        modal.classList.remove('hidden'); // NoÅ†emam hidden
        modal.classList.add('flex');      // Pievienojam flex, lai centrÄ“tu
    }
}
        function closeDeleteModal() {
    const modal = document.getElementById('deleteModal');
    if (modal) {
        modal.classList.add('hidden');    // PaslÄ“pjam
        modal.classList.remove('flex');   // NoÅ†emam flex
    }
    currentOrderId = null;
}
        async function loadBannerData() {
            const res = await fetch('/api/settings/banner');
            const data = await res.json();
            currentBannerStatus = data.enabled;
            document.getElementById('bannerText').value = data.text || "";
            updateBannerModalUI();
        }
        function openBannerModal() { document.getElementById('bannerModal').classList.replace('hidden', 'flex'); }
        function closeBannerModal() { document.getElementById('bannerModal').classList.replace('flex', 'hidden'); }
        function toggleBannerState() { currentBannerStatus = !currentBannerStatus; updateBannerModalUI(); }
        function updateBannerModalUI() {
            const btn = document.getElementById('bannerToggleBtn');
            const circle = document.getElementById('bannerToggleCircle');
            btn.className = `relative inline-flex h-6 w-12 items-center rounded-full transition-colors ${currentBannerStatus ? 'bg-red-600' : 'bg-slate-700'}`;
            circle.className = `inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${currentBannerStatus ? 'translate-x-7' : 'translate-x-1'}`;
        }
        async function saveBannerSettings() {
            await fetch('/api/settings/banner', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: currentBannerStatus, text: document.getElementById('bannerText').value })
            });
            closeBannerModal();
        }
        window.onclick = (e) => {
            if (e.target.id === 'orderModal') closeModal();
            if (e.target.id === 'bannerModal') closeBannerModal();
        }

        async function deleteOrder() {
    if (!currentOrderId) return;

    try {
        const response = await fetch(`/api/admin/delete/${currentOrderId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            console.log("Pieteikums arhivÄ“ts un izdzÄ“sts");
            closeDeleteModal(); 
            fetchOrders(); // Å eit bija kÄ¼Å«da - jÄbÅ«t fetchOrders(), nevis loadOrders()
        } else {
            const errorMsg = await response.text();
            alert("Servera kÄ¼Å«da: " + errorMsg);
        }
    } catch (error) {
        console.error("SaziÅ†as kÄ¼Å«da:", error);
        alert("NeizdevÄs sazinÄties ar serveri. PÄrbaudi vai terminÄlÄ« nav kÄ¼Å«du!");
    }
}

function openWhatsApp(vards, talrunis, pakalpojums, statuss) {
    // 1. Sagatavojam numuru
    let phone = talrunis.toString().replace(/\D/g, '');
    if (phone.startsWith('2') && phone.length === 8) phone = '371' + phone;

    // 2. DroÅ¡Ä«bas pÄ“c pÄrveidojam statusu uz mazajiem burtiem, lai vieglÄk salÄ«dzinÄt
    const s = statuss ? statuss.toLowerCase() : '';
    
    let message = "";

    // 3. PÄrbaudÄm statusus (pielÄgo Å¡os vÄrdus savÄm kolonnÄm)
    if (s === 'gatavs') {
        message = `Labdien, ${vards}! *ARCUS* serviss informÄ“: JÅ«su ierÄ«ce (${pakalpojums}) ir saremontÄ“ta un gaida JÅ«s!`;
    } 
    else if (s === 'remontÄ' || s === 'remonts') {
        message = `Labdien, ${vards}! *ARCUS* serviss informÄ“: JÅ«su ierÄ«ce (${pakalpojums}) Å¡obrÄ«d tiek remontÄ“ta.`;
    } 
    else {
        // Å Ä« ziÅ†a aizies visos citos gadÄ«jumos (SaÅ†emts, Jauns, utt.)
        message = `Labdien, ${vards}! *ARCUS* serviss informÄ“: JÅ«su pieteikums (${pakalpojums}) ir saÅ†emts un pieÅ†emts rindÄ.`;
    }

    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
}

    </script>
</body>
</html>